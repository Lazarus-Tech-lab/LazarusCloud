<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lazarus Cloud</title>
    <link rel="stylesheet" href="style/main.css">
    <style>
        
    </style>
</head>
<body>
    <div class="noise"></div>
    
    <div class="burger" id="burger">‚ò∞</div>
    <div class="view-switcher" id="viewSwitcher">
        <button class="view-btn active" data-view="grid">‚ò∑ Grid</button>
        <button class="view-btn" data-view="list">‚ò∞ List</button>
    </div>
    
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="logo">DOLLARS<span class="cursor"></span></div>
            <div class="user-info">
                <div id="userName" class="skeleton" style="height: 18px; width: 100px;">Loading...</div>
                <div id="quotaInfo" class="skeleton" style="height: 14px; width: 130px; font-size: 11px;">Loading...</div>
            </div>
            <div class="menu-item active" data-section="my-files">üìÅ My Files</div>
            <div class="menu-item" data-section="shared">üîó Shared</div>
            <div class="menu-item" data-section="trash">üóëÔ∏è Trash</div>
            <div class="menu-item" data-section="notifications">
                üîî Notifications
                <span class="menu-badge" id="menuBadge">3</span>
            </div>
            <div class="menu-item" data-section="settings">‚öôÔ∏è Settings</div>
        </div>

        <div class="main">
            <div class="path-bar" id="pathBar">
                <span>CLOUD:</span>
                <span id="currentPath">/home</span>
            </div>

            <div id="filesContainer" class="files-grid">
                <!-- Content will be loaded dynamically -->
            </div>

            <div id="settingsContent" class="settings-section" style="display:none;">
                <div class="setting-item">
                    <div class="setting-title">Dark Mode</div>
                    <div class="setting-description">Enable dark theme for better night experience</div>
                    <div class="setting-controls">
                        <label class="toggle-switch">
                            <input type="checkbox" id="darkModeToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-title">Auto-sync</div>
                    <div class="setting-description">Automatically sync files with cloud storage</div>
                    <div class="setting-controls">
                        <label class="toggle-switch">
                            <input type="checkbox" id="autoSyncToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-title">Username</div>
                    <div class="setting-description">Change your display name</div>
                    <input type="text" class="text-input" id="usernameInput" placeholder="Enter new username">
                </div>

                <div class="setting-item">
                    <div class="setting-title">Email Notifications</div>
                    <div class="setting-description">Receive important updates via email</div>
                    <input type="email" class="text-input" id="emailInput" placeholder="your@email.com">
                </div>

                <button class="save-btn" id="saveSettingsBtn">Save Settings</button>
            </div>
        </div>
    </div>

    <div class="notification-container" id="notificationContainer">
        <!-- Notifications will be added here -->
    </div>

    <div class="bottom-panel">
        <div>Status: <span style="color: #0f0;">Connected</span></div>
<!--        <div>User: <span id="userName" class="skeleton" style="width: 100px;">Loading...</span></div>-->
<!--        <div>Storage: <span id="quotaInfo" class="skeleton" style="width: 140px;">Loading...</span></div>-->
        <div class="theme-switcher" id="themeSwitcher">üåô Dark Mode</div>

    </div>

    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" data-action="open">üìÇ Open</div>
        <div class="context-menu-item" data-action="download">‚è¨ Download</div>
        <div class="context-menu-item" data-action="rename">‚úèÔ∏è Rename</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" data-action="delete">üóëÔ∏è Delete</div>
    </div>

    <!-- Modal for rename -->
    <div class="modal-overlay" id="renameModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Rename File</div>
                <button class="modal-close" id="closeRenameModal">√ó</button>
            </div>
            <div class="modal-body">
                <input type="text" class="modal-input" id="renameInput" placeholder="Enter new name">
            </div>
            <div class="modal-footer">
                <button class="modal-btn" id="cancelRenameBtn">Cancel</button>
                <button class="modal-btn modal-btn-primary" id="confirmRenameBtn">Rename</button>
            </div>
        </div>
    </div>

    <!-- Modal for delete confirmation -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Delete File</div>
                <button class="modal-close" id="closeDeleteModal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="confirmation-text">
                    Are you sure you want to delete <strong id="fileToDeleteName"></strong>? 
                    This action cannot be undone.
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn" id="cancelDeleteBtn">Cancel</button>
                <button class="modal-btn modal-btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>

    <!-- Modal for file properties -->
    <div class="modal-overlay" id="propertiesModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">File Properties</div>
                <button class="modal-close" id="closePropertiesModal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="file-property">
                    <div class="file-property-label">Name:</div>
                    <div class="file-property-value" id="propFileName"></div>
                </div>
                <div class="file-property">
                    <div class="file-property-label">Type:</div>
                    <div class="file-property-value" id="propFileType"></div>
                </div>
                <div class="file-property">
                    <div class="file-property-label">Size:</div>
                    <div class="file-property-value" id="propFileSize"></div>
                </div>
                <div class="file-property">
                    <div class="file-property-label">Created:</div>
                    <div class="file-property-value" id="propFileCreated"></div>
                </div>
                <div class="file-property">
                    <div class="file-property-label">Modified:</div>
                    <div class="file-property-value" id="propFileModified"></div>
                </div>
                <div class="file-property">
                    <div class="file-property-label">Location:</div>
                    <div class="file-property-value" id="propFileLocation"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-primary" id="closePropertiesBtn">Close</button>
            </div>
        </div>
    </div>

    <script>

        window.addEventListener('DOMContentLoaded', () => {
            // –¥—Ä—É–≥–∏–µ –≤—ã–∑–æ–≤—ã...
            loadUserData();
            loadFiles();
        });
        async function loadUserData() {
            try {
                const res = await fetch('/api/userdata', {
                    method: 'GET',
                    credentials: 'include' // –≤–∞–∂–Ω–æ –¥–ª—è –∫—É–∫–∏!
                });

                if (!res.ok) throw new Error('Unauthorized');

                const data = await res.json();

                // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userNameEl = document.getElementById('userName');
                if (userNameEl) {
                    userNameEl.textContent = data.username;
                    userNameEl.classList.remove('skeleton');
                }

                // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–≤–æ—Ç—É
                const quotaInfoEl = document.getElementById('quotaInfo');
                if (quotaInfoEl) {
                    quotaInfoEl.textContent = `${formatBytes(data.usedQuota)} / ${formatBytes(data.quota)}`;
                    quotaInfoEl.classList.remove('skeleton');
                }

            } catch (err) {
                console.error('[loadUserData]', err);
                window.location.href = '/auth.html';
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return parseFloat((bytes / Math.pow(1024, i)).toFixed(1)) + ' ' + sizes[i];
        }


        async function loadFiles() {
            const container = document.getElementById('filesContainer');
            if (!container) return;

            // –û—á–∏—Å—Ç–∏—Ç—å –∏ –ø–æ–∫–∞–∑–∞—Ç—å —Å–∫–µ–ª–µ—Ç–æ–Ω—ã
            container.innerHTML = '';
            for (let i = 0; i < 6; i++) {
                const skeleton = document.createElement('div');
                skeleton.className = 'file-skeleton';
                container.appendChild(skeleton);
            }

            try {
                const res = await fetch('/api/storage/files', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (!res.ok) throw new Error('Unauthorized');

                const files = await res.json();

                container.innerHTML = ''; // –æ—á–∏—Å—Ç–∏—Ç—å —Å–∫–µ–ª–µ—Ç–æ–Ω—ã

                files.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.setAttribute('data-type', file.isFolder ? 'folder' : 'file');

                    fileItem.innerHTML = `
                <div class="file-icon">${file.isFolder ? 'üìÅ' : 'üìÑ'}</div>
                <div class="file-name">${file.filename}</div>
            `;

                    container.appendChild(fileItem);
                });

            } catch (err) {
                console.error('[loadFiles]', err);
                container.innerHTML = '<div style="color:red;">Failed to load files</div>';
            }
        }

        // Data for each section
        const sectionData = {
            'my-files': [
                {
                    "Id": 1,
                    "filename": "homeVpn.conf",
                    "serverName": "a3a9a8d8-1bda-4ab5-a79b-4ba3929b998c.conf",
                    "ownerId": 1,
                    "fileSize": 317.0,
                    "isShared": false,
                    "path": "uploads/homeVpn.conf"
                },
                {
                    "Id": 2,
                    "filename": "762a86ed-1baa-4e1f-b0d9-aab0744fc269.sh",
                    "serverName": "762a86ed-1baa-4e1f-b0d9-aab0744fc269.sh",
                    "ownerId": 1,
                    "fileSize": 22592.0,
                    "isShared": false,
                    "path": "uploads/get-docker.sh"
                },
                {
                    "Id": 3,
                    "filename": "5475e3f4-36b0-4173-8af6-36bbf8ebb351.conf",
                    "serverName": "5475e3f4-36b0-4173-8af6-36bbf8ebb351.conf",
                    "ownerId": 1,
                    "fileSize": 319.0,
                    "isShared": false,
                    "path": "uploads/5475e3f4-36b0-4173-8af6-36bbf8ebb351.conf"
                },
                {
                    "Id": 4,
                    "filename": "wg0-client-reds-pc.conf",
                    "serverName": "bfa36265-5f70-4aab-8a79-0c976996eb62.conf",
                    "ownerId": 1,
                    "fileSize": 319.0,
                    "isShared": true,
                    "path": "uploads/bfa36265-5f70-4aab-8a79-0c976996eb62.conf"
                },
                {
                    "Id": 5,
                    "filename": "–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏.xml",
                    "serverName": "–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏.xml",
                    "ownerId": 1,
                    "fileSize": 67.0,
                    "isShared": true,
                    "path": "uploads/c3b03cdc-1e4e-4cbe-be61-a6e3f42baddc.xml"
                },
                {
                    "Id": 6,
                    "filename": "wg0-client-reds-pc.conf",
                    "serverName": "945dc565-e347-4f77-bf3c-355e4f40a58c",
                    "ownerId": 1,
                    "fileSize": 319.0,
                    "isShared": true,
                    "path": "uploads/508f2846-0dae-47bf-bcbb-e3872396be3f.conf"
                },
                {
                    "Id": 7,
                    "filename": "–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏.xml",
                    "serverName": "00547730-847b-49cf-96e4-b0bfdb926b98",
                    "ownerId": 1,
                    "fileSize": 67.0,
                    "isShared": false,
                    "path": "uploads/e454d085-4af2-4089-8eb3-45aa88c74c2a.xml"
                }
            ],
            'shared': [
                { name: 'gangs_list.xlsx', type: 'file', icon: 'üìä', size: '1.8 MB' },
                { name: 'dollars_chat.log', type: 'file', icon: 'üí¨', size: '4.5 MB' },
                { name: 'shared_photos', type: 'folder', icon: 'üìÅ', size: '--' }
            ],
            'trash': [
                { name: 'old_plans.txt', type: 'file', icon: 'üóëÔ∏è', size: '1.2 KB' },
                { name: 'deleted_screenshots', type: 'folder', icon: 'üóëÔ∏è', size: '--' }
            ],
            'notifications': [
                { name: 'system_alerts.log', type: 'file', icon: '‚ö†Ô∏è', size: '1.5 MB' },
                { name: 'message_history.json', type: 'file', icon: '‚úâÔ∏è', size: '2.3 MB' }
            ],
            'settings': []
        };

        // DOM elements
        const filesContainer = document.getElementById('filesContainer');
        const currentPath = document.getElementById('currentPath');
        const contextMenu = document.getElementById('contextMenu');
        const notificationContainer = document.getElementById('notificationContainer');
        const menuBadge = document.getElementById('menuBadge');
        let selectedFile = null;
        let currentView = 'grid';
        let notificationCount = 3;

        // Check saved theme in localStorage
        function checkSavedTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-theme');
                document.getElementById('themeSwitcher').textContent = '‚òÄÔ∏è Light Mode';
                document.getElementById('darkModeToggle').checked = false;
            } else {
                document.body.classList.remove('light-theme');
                document.getElementById('themeSwitcher').textContent = 'üåô Dark Mode';
                document.getElementById('darkModeToggle').checked = true;
            }
        }

        // Save theme to localStorage
        function saveThemeToStorage(isDark) {
            if (isDark) {
                localStorage.setItem('theme', 'dark');
            } else {
                localStorage.setItem('theme', 'light');
            }
        }

        // Load section content
        function loadSectionContent(sectionId) {
            filesContainer.innerHTML = '';
            currentPath.textContent = sectionId;
            
            // Hide all special sections
            document.getElementById('settingsContent').style.display = 'none';
            filesContainer.style.display = 'grid';
            
            if (sectionId === 'settings') {
                // Show special content for settings
                filesContainer.style.display = 'none';
                document.getElementById('settingsContent').style.display = 'block';
                
                // Load saved settings
                loadSettings();
            } else {
                // Regular content for other sections
                const files = sectionData[sectionId] || [];
                
                files.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.setAttribute('data-type', file.type);
                    
                    if (currentView === 'grid') {
                        fileItem.innerHTML = `
                            <div class="file-icon">${file.icon}</div>
                            <div class="file-name">${file.name}</div>
                        `;
                    } else {
                        fileItem.innerHTML = `
                            <div class="file-icon">${file.icon}</div>
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${file.size}</div>
                        `;
                    }
                    
                    filesContainer.appendChild(fileItem);
                });
            }
            
            initFileItems();
        }

        // Set view (grid/list)
        function setView(view) {
            currentView = view;
            filesContainer.className = view === 'grid' ? 'files-grid' : 'files-list';
            
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-view') === view);
            });
            
            loadSectionContent(currentPath.textContent);
        }

        // Initialize file item handlers
        function initFileItems() {
            document.querySelectorAll('.file-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    if (e.target.classList.contains('context-menu-item')) return;
                    
                    document.querySelectorAll('.file-item').forEach(i => {
                        i.style.borderColor = 'var(--file-border)';
                    });
                    this.style.borderColor = '#ff0';
                    selectedFile = this;
                });

                // Double click to open properties
                item.addEventListener('dblclick', function() {
                    const fileName = this.querySelector('.file-name').textContent;
                    const fileType = this.getAttribute('data-type');
                    const fileSize = this.querySelector('.file-size')?.textContent || '--';
                    showFileProperties(fileName, fileType, fileSize);
                });
            });
        }

        // Menu item handlers
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function() {
                const sectionId = this.getAttribute('data-section');
                
                document.querySelectorAll('.menu-item').forEach(i => {
                    i.classList.remove('active');
                });
                
                this.classList.add('active');
                loadSectionContent(sectionId);
                
                // Reset badge when going to notifications
                if (sectionId === 'notifications') {
                    notificationCount = 0;
                    menuBadge.style.display = 'none';
                }
                
                if (window.innerWidth <= 768) {
                    document.getElementById('sidebar').classList.remove('active');
                }
            });
        });

        // View switcher
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                setView(this.getAttribute('data-view'));
            });
        });

        // Show notification
        function showNotification(title, message, time = 'Just now') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <button class="notification-close">‚úï</button>
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
                <div class="notification-time" style="font-size:11px;color:var(--path-color);margin-top:5px;">${time}</div>
            `;
            
            notificationContainer.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            notification.querySelector('.notification-close').addEventListener('click', () => {
                notification.remove();
                updateBadge(-1);
            });
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                    updateBadge(-1);
                }
            }, 5000);
            
            updateBadge(1);
        }

        // Update badge
        function updateBadge(change) {
            notificationCount += change;
            menuBadge.textContent = notificationCount > 0 ? notificationCount : '';
            menuBadge.style.display = notificationCount > 0 ? 'flex' : 'none';
        }

        // Load saved settings
        function loadSettings() {
            // Check saved theme
            const savedTheme = localStorage.getItem('theme');
            const isDarkMode = savedTheme !== 'light';
            
            document.getElementById('darkModeToggle').checked = isDarkMode;
            document.getElementById('autoSyncToggle').checked = false;
            document.getElementById('usernameInput').value = 'anonymous';
            document.getElementById('emailInput').value = '';
        }

        // Save settings
        function saveSettings() {
            const settings = {
                darkMode: document.getElementById('darkModeToggle').checked,
                autoSync: document.getElementById('autoSyncToggle').checked,
                username: document.getElementById('usernameInput').value,
                email: document.getElementById('emailInput').value
            };
            
            // Save theme
            saveThemeToStorage(settings.darkMode);
            
            // In a real app, this would be sent to the server
            console.log('Settings saved:', settings);
            
            // Apply some settings immediately
            if (settings.darkMode) {
                document.body.classList.remove('light-theme');
                document.getElementById('themeSwitcher').textContent = 'üåô Dark Mode';
            } else {
                document.body.classList.add('light-theme');
                document.getElementById('themeSwitcher').textContent = '‚òÄÔ∏è Light Mode';
            }
            
            // Show save notification
            showNotification(
                "Settings Saved", 
                "Your preferences have been successfully updated",
                "Just now"
            );
        }

        // Demo notifications
        const demoNotifications = [
            {
                title: "New file shared",
                message: "User 'Celty' shared 'helmet_blueprints.pdf' with you",
                time: "2 min ago"
            },
            {
                title: "Storage alert",
                message: "You've used 85% of your storage. Upgrade now!",
                time: "1 hour ago"
            },
            {
                title: "System update",
                message: "New security patch available. Restart to apply.",
                time: "3 days ago"
            }
        ];

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.body.style.overflow = '';
        }

        // File operations with modals
        document.querySelectorAll('.context-menu-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const action = e.target.getAttribute('data-action');
                const fileName = selectedFile.querySelector('.file-name').textContent;
                const fileType = selectedFile.getAttribute('data-type');
                const fileSize = selectedFile.querySelector('.file-size')?.textContent || '--';
                
                switch(action) {
                    case 'open':
                        // For folders we would navigate, for files - show properties
                        if (fileType === 'folder') {
                            // Navigate to folder (implementation depends on your structure)
                            showNotification('Navigation', `Opening folder: ${fileName}`, 'Now');
                        } else {
                            showFileProperties(fileName, fileType, fileSize);
                        }
                        break;
                    case 'download':
                        showNotification('Download', `Preparing to download: ${fileName}`, 'Now');
                        break;
                    case 'rename':
                        showRenameModal(fileName);
                        break;
                    case 'delete':
                        showDeleteModal(fileName);
                        break;
                }
                
                contextMenu.style.display = 'none';
            });
        });

        function showRenameModal(currentName) {
            const renameInput = document.getElementById('renameInput');
            renameInput.value = currentName;
            renameInput.select();
            openModal('renameModal');
        }

        function showDeleteModal(fileName) {
            document.getElementById('fileToDeleteName').textContent = fileName;
            openModal('deleteModal');
        }

        function showFileProperties(name, type, size) {
            document.getElementById('propFileName').textContent = name;
            document.getElementById('propFileType').textContent = type === 'folder' ? 'Folder' : 'File';
            document.getElementById('propFileSize').textContent = size;
            
            // Generate random dates for demo purposes
            const now = new Date();
            const createdDate = new Date(now.getTime() - Math.random() * 30 * 24 * 60 * 60 * 1000);
            const modifiedDate = new Date(createdDate.getTime() + Math.random() * 10 * 24 * 60 * 60 * 1000);
            
            document.getElementById('propFileCreated').textContent = createdDate.toLocaleString();
            document.getElementById('propFileModified').textContent = modifiedDate.toLocaleString();
            document.getElementById('propFileLocation').textContent = `/DollarsNET/${currentPath.textContent}`;
            
            openModal('propertiesModal');
        }

        // Initialize on DOM load
        window.addEventListener('DOMContentLoaded', () => {
            // Check saved theme
            checkSavedTheme();
            
            // Show demo notifications
            demoNotifications.forEach((note, index) => {
                setTimeout(() => {
                    showNotification(note.title, note.message, note.time);
                }, index * 300);
            });
        });

        // Initial setup
        setView('grid');
        loadSectionContent('my-files');

        // Burger menu
        document.getElementById('burger').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('active');
        });

        // Theme switcher
        document.getElementById('themeSwitcher').addEventListener('click', () => {
            const isLight = document.body.classList.toggle('light-theme');
            document.getElementById('themeSwitcher').textContent = 
                isLight ? 'üåô Dark Mode' : '‚òÄÔ∏è Light Mode';
            
            // Save theme choice
            saveThemeToStorage(!isLight);
            
            // Update toggle in settings
            document.getElementById('darkModeToggle').checked = !isLight;
        });

        // Save settings button
        document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);

        // Context menu
        document.addEventListener('contextmenu', (e) => {
            if (e.target.closest('.file-item')) {
                e.preventDefault();
                selectedFile = e.target.closest('.file-item');
                
                let posX = e.pageX;
                let posY = e.pageY;
                
                if (posX + contextMenu.offsetWidth > window.innerWidth) {
                    posX = window.innerWidth - contextMenu.offsetWidth;
                }
                if (posY + contextMenu.offsetHeight > window.innerHeight) {
                    posY = window.innerHeight - contextMenu.offsetHeight;
                }
                
                contextMenu.style.left = posX + 'px';
                contextMenu.style.top = posY + 'px';
                contextMenu.style.display = 'block';
                
                document.querySelectorAll('.file-item').forEach(item => {
                    item.style.borderColor = 'var(--file-border)';
                });
                selectedFile.style.borderColor = '#ff0';
            } else {
                contextMenu.style.display = 'none';
            }
        });

        document.addEventListener('click', (e) => {
            if (!contextMenu.contains(e.target)) {
                contextMenu.style.display = 'none';
            }
            
            if (window.innerWidth <= 768 && !document.getElementById('sidebar').contains(e.target) && 
                e.target !== document.getElementById('burger')) {
                document.getElementById('sidebar').classList.remove('active');
            }
        });

        // Close modals when clicking outside
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal(this.id);
                }
            });
        });

        // Modal event listeners
        document.getElementById('closeRenameModal').addEventListener('click', () => closeModal('renameModal'));
        document.getElementById('cancelRenameBtn').addEventListener('click', () => closeModal('renameModal'));
        document.getElementById('confirmRenameBtn').addEventListener('click', () => {
            const newName = document.getElementById('renameInput').value.trim();
            if (newName && newName !== selectedFile.querySelector('.file-name').textContent) {
                selectedFile.querySelector('.file-name').textContent = newName;
                showNotification('File Renamed', `File renamed to: ${newName}`, 'Now');
            }
            closeModal('renameModal');
        });

        document.getElementById('closeDeleteModal').addEventListener('click', () => closeModal('deleteModal'));
        document.getElementById('cancelDeleteBtn').addEventListener('click', () => closeModal('deleteModal'));
        document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
            const fileName = document.getElementById('fileToDeleteName').textContent;
            selectedFile.style.animation = 'fadeOut 0.3s forwards';
            setTimeout(() => {
                selectedFile.remove();
                showNotification('File Deleted', `File deleted: ${fileName}`, 'Now');
            }, 300);
            closeModal('deleteModal');
        });

        document.getElementById('closePropertiesModal').addEventListener('click', () => closeModal('propertiesModal'));
        document.getElementById('closePropertiesBtn').addEventListener('click', () => closeModal('propertiesModal'));

        // Allow Enter key in rename modal
        document.getElementById('renameInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('confirmRenameBtn').click();
            }
        });

        // Test button for notifications (can be removed in production)
        document.getElementById('viewSwitcher').addEventListener('dblclick', () => {
            showNotification(
                "Test Notification", 
                "Double-click on view switcher to test notifications",
                "Now"
            );
        });
    </script>
</body>
</html>