<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lazarus Cloud</title>
    <link th:href="@{/style/main.css}" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=delete" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=download" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=edit" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&animation=hover" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,400,0,0" />
</head>
<body>
<div class="noise"></div>
<input type="file" id="fileInput" style="display: none;" multiple
       accept="*/*"
       capture="environment">
<!-- Main App Container -->
<div class="container">
    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar" aria-label="Main navigation">

        <div class="logo">LazarusCloud<span class="cursor"></span></div>

        <div class="user-info">
            <div id="userName" class="skeleton" style="height: 18px; width: 100px;">Loading...</div>
            <div id="quotaInfo" class="skeleton" style="height: 14px; width: 130px; font-size: 11px;">Loading...</div>
        </div>

        <div class="actions-section">
            <button class="sidebar-action" id="uploadFileBtn">
                <span class="material-symbols-outlined">upload</span>
                <span class="action-text">Upload</span>
            </button>
            <button class="sidebar-action" id="createFolderBtn">
                <span class="material-symbols-outlined">create_new_folder</span>
                <span class="action-text">New Folder</span>
            </button>
        </div>

        <div class="menu-item active" data-section="my-files" role="button" tabindex="0">
            <span aria-hidden="true">üìÅ</span> My Files
        </div>
        <div class="menu-item" data-section="shared" role="button" tabindex="0">
            <span aria-hidden="true">üîó</span> Shared
        </div>
        <div class="menu-item" data-section="trash" role="button" tabindex="0">
            <span aria-hidden="true">üóëÔ∏è</span> Trash
        </div>
        <div class="menu-item" data-section="notifications" role="button" tabindex="0">
            <span aria-hidden="true">üîî</span> Notifications
            <span class="menu-badge" id="menuBadge">3</span>
        </div>
        <div class="menu-item" data-section="settings" role="button" tabindex="0">
            <span aria-hidden="true">‚öôÔ∏è</span> Settings
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="main-blocks">
        <header class="header">


            <div class="files-action-bar">
                <div class="action-buttons">
                    <div class="burger" id="burger" onclick="toggleSidebar()">‚ò∞</div>
                    <input type="text" id="fileSearchInput" placeholder="Search..." class="text-input" style="margin-left: auto;">
                    <button class="view-btn active" data-view="grid">‚ò∑ Grid</button>
                    <button class="view-btn" data-view="list">‚ò∞ List</button>
                    <button class="view-btn" id="themeSwitcher" style="min-width: 40px;">üåô</button>
                </div>
            </div>

            <div id="audioPlayer" class="custom-audio-player hidden">
                <div class="player-header">
                    <div class="player-info">
                        <div class="player-thumb">
                            <img id="audioPic" class="player-img" src="/placeholder.jpg" alt="–û–±–ª–æ–∂–∫–∞">
                        </div>
                        <div class="player-details">
                            <div id="audioTitle" class="player-title">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞</div>
                            <div id="audioArtist" class="player-artist">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</div>
                        </div>
                    </div>

                    <div class="player-time">
                        <span id="currentTime">0:00</span> / <span id="duration">0:00</span>
                    </div>

                    <button class="player-close" id="closePlayer">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <div class="player-controls-row">
                    <div class="player-main-controls">
                        <button class="control-btn" id="prevBtn">
                            <span class="material-symbols-outlined">skip_previous</span>
                        </button>
                        <button class="control-btn main-btn" id="playPauseBtn">
                            <span class="material-symbols-outlined">play_arrow</span>
                        </button>
                        <button class="control-btn" id="nextBtn">
                            <span class="material-symbols-outlined">skip_next</span>
                        </button>
                    </div>

                    <div class="progress-container">
                        <input type="range" id="progressBar" class="progress-bar" value="0" min="0">
                    </div>

                    <div class="player-extra-controls">
                        <div class="volume-container">
                            <button class="volume-btn" id="volumeBtn">
                                <span class="material-symbols-outlined">volume_up</span>
                            </button>
                            <input type="range" id="volumeBar" class="volume-bar" value="100" min="0" max="100">
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Recommendations Section -->
        <section class="recommendation-container" aria-label="Quick access">
            <div class="recommendation rec-photo" role="button" tabindex="0">
                <div class="recommendation-text">Photos</div>
            </div>
            <div class="recommendation rec-music" role="button" tabindex="0">
                <div class="recommendation-text">Music</div>
            </div>
            <div class="recommendation rec-files" role="button" tabindex="0">
                <div class="recommendation-text">Files</div>
            </div>
        </section>

        <!-- Files Content Section -->
        <section class="main">
            <div class="path-bar" id="pathBar">
                <span>CLOUD:</span>
                <span id="currentPath">/home</span>
            </div>

            <div id="filesContainer" class="files-grid" role="grid" aria-label="Files and folders">
                <!-- Files will be rendered here -->
                <div>GBC</div>
            </div>

            <div id="settingsContent" class="settings-section" style="display:none;">
                <div class="setting-item">
                    <div class="setting-title">Dark Mode</div>
                    <div class="setting-controls">
                        <label class="toggle-switch">
                            <input type="checkbox" id="darkModeToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </section>
    </main>
</div>

<!-- Notification System -->
<div class="notification-container" id="notificationContainer" role="status" aria-live="polite"></div>

<!-- Context Menu -->
<nav class="context-menu" id="contextMenu" role="menu" aria-hidden="true">
    <div class="context-menu-item" data-action="open" role="menuitem">üìÇ Open</div>
    <div class="context-menu-item" data-action="download" role="menuitem">‚è¨ Download</div>
    <div class="context-menu-item" data-action="rename" role="menuitem">‚úèÔ∏è Rename</div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" data-action="properties" role="menuitem">‚ÑπÔ∏è Properties</div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" data-action="delete" role="menuitem">üóëÔ∏è Delete</div>
</nav>

<input type="hidden" id="current_folder_id">

<!-- File Properties Panel -->
<aside class="file-properties-panel" id="propertiesPanel" aria-hidden="true">
    <div class="properties-header">
        <button class="properties-close" id="closeProperties" aria-label="Close properties">&times;</button>
        <h3>Properties</h3>
    </div>
    <div class="properties-content">
        <div class="property-icon">
            <span id="propertyFileIcon" aria-hidden="true">üìÑ</span>
        </div>
        <div class="property-item">
            <span class="property-label">Name:</span>
            <span id="propertyFileName" class="property-value"></span>
        </div>
        <div class="property-item">
            <span class="property-label">Type:</span>
            <span id="propertyFileType" class="property-value"></span>
        </div>
        <div class="property-item">
            <span class="property-label">Size:</span>
            <span id="propertyFileSize" class="property-value"></span>
        </div>
        <div class="property-item">
            <span class="property-label">Upload date:</span>
            <span id="propertyFileDate" class="property-value"></span>
        </div>
        <div class="property-item">
            <span class="property-label">Owner:</span>
            <span id="propertyFileOwner" class="property-value"></span>
        </div>
    </div>
</aside>

<!-- Preview Modal -->
<dialog class="resizable-preview" id="previewModal" aria-modal="true">
    <div class="preview-header">
        <h2 id="previewTitle">Preview</h2>
        <button class="preview-close" onclick="closePreviewModal()" aria-label="Close preview">√ó</button>
    </div>
    <div class="preview-body" id="previewContent"></div>
    <div class="preview-resizer" id="previewResizer"></div>
</dialog>

<script>
    // –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π JavaScript –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    const fileCache = {};
    let folderPath = [];
    let currentView = 'grid';
    let currentPath = '/home';
    let selectedFile = null;

    window.addEventListener('DOMContentLoaded', () => {
        checkSavedTheme();
        setView('grid');
        loadUserData();
        loadSectionContent('my-files');
        updateBreadcrumb();
        setupContextMenu();

        document.getElementById('closeProperties')?.addEventListener('click', () => {
            document.getElementById('propertiesPanel').classList.remove('active');
        });
    });

    function checkSavedTheme() {
        const savedTheme = localStorage.getItem('theme');
        const isLight = savedTheme === 'light';
        document.body.classList.toggle('light-theme', isLight);
        document.getElementById('themeSwitcher').textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
        document.getElementById('darkModeToggle').checked = !isLight;
    }

    function saveThemeToStorage(isDark) {
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const view = btn.getAttribute('data-view');
            if (view) setView(view);
        });
    });

    document.querySelectorAll('.menu-item').forEach(item => {
        item.addEventListener('click', () => {
            const sectionId = item.getAttribute('data-section');
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            item.classList.add('active');
            loadSectionContent(sectionId);

            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        });
    });

    function applyView() {
        const filesContainer = document.getElementById('filesContainer');
        if (!filesContainer) return;

        filesContainer.className = currentView === 'grid' ? 'files-grid' : 'files-list';

        document.querySelectorAll('.view-btn').forEach(btn => {
            const btnView = btn.getAttribute('data-view');
            btn.classList.toggle('active', btnView === currentView);
        });
    }

    function setView(view) {
        if (view !== 'grid' && view !== 'list') return;
        currentView = view;
        applyView();

        if (fileCache[currentPath]) {
            renderFiles(fileCache[currentPath]);
        }
    }

    function renderFiles(files) {
        const container = document.getElementById('filesContainer');
        if (!container || !files) return;

        container.className = currentView === 'grid' ? 'files-grid' : 'files-list';
        container.innerHTML = '';

        files.forEach(file => {
            const item = document.createElement('div');
            item.className = 'file-item';
            item.setAttribute('data-type', file.isFolder ? 'folder' : 'file');
            item.setAttribute('data-uuid', file.serverName);
            item.setAttribute('role', 'gridcell');
            item.setAttribute('aria-label', `${file.isFolder ? 'Folder' : 'File'}: ${file.filename}`);
            item.innerHTML = `
                    <div class="file-icon"><img class="thumbnail-icon" id="${item.getAttribute('data-uuid')}" src="/api/storage/raw/thumb/${item.getAttribute('data-uuid')}" alt="${file.filename} thumbnail"></div>
                    <div class="file-container">
                        <div class="file-name">${file.filename}</div>
                        <div class="file-info">${formatBytes(file.size)}</div>

                        <div class="file-action-btns">
                           <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3" aria-hidden="true"><path d="M200-200h57l391-391-57-57-391 391v57Zm-80 80v-170l528-527q12-11 26.5-17t30.5-6q16 0 31 6t26 18l55 56q12 11 17.5 26t5.5 30q0 16-5.5 30.5T817-647L290-120H120Zm640-584-56-56 56 56Zm-141 85-28-29 57 57-29-28Z"/></svg>
                            <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3" aria-hidden="true"><path d="M480-320 280-520l56-58 104 104v-326h80v326l104-104 56 58-200 200ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z"/></svg>
                            <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3" aria-hidden="true"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg>
                            <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3" aria-hidden="true"><path d="M680-80q-50 0-85-35t-35-85q0-6 3-28L282-392q-16 15-37 23.5t-45 8.5q-50 0-85-35t-35-85q0-50 35-85t85-35q24 0 45 8.5t37 23.5l281-164q-2-7-2.5-13.5T560-760q0-50 35-85t85-35q50 0 85 35t35 85q0 50-35 85t-85 35q-24 0-45-8.5T598-672L317-508q2 7 2.5 13.5t.5 14.5q0 8-.5 14.5T317-452l281 164q16-15 37-23.5t45-8.5q50 0 85 35t35 85q0 50-35 85t-85 35Zm0-80q17 0 28.5-11.5T720-200q0-17-11.5-28.5T680-240q-17 0-28.5 11.5T640-200q0 17 11.5 28.5T680-160ZM200-440q17 0 28.5-11.5T240-480q0-17-11.5-28.5T200-520q-17 0-28.5 11.5T160-480q0 17 11.5 28.5T200-440Zm480-280q17 0 28.5-11.5T720-760q0-17-11.5-28.5T680-800q-17 0-28.5 11.5T640-760q0 17 11.5 28.5T680-720Zm0 520ZM200-480Zm480-280Z"/></svg>
                        </div>
                    </div>
                `;

            item.addEventListener('click', async () => {
                if (file.isFolder && file.serverName) {
                    folderPath.push({ id: file.serverName, name: file.filename });
                    await loadFolderById(file.serverName);
                }
            });

            container.appendChild(item);
        });
    }

    async function loadSectionContent(sectionId) {
        const container = document.getElementById('filesContainer');
        const pathLabel = document.getElementById('currentPath');
        if (!container || !pathLabel) return;

        pathLabel.textContent = sectionId === 'my-files' ? '/home' : `/${sectionId}`;
        currentPath = sectionId;

        if (fileCache[sectionId]) {
            renderFiles(fileCache[sectionId]);
            return;
        }

        container.innerHTML = '';
        for (let i = 0; i < 6; i++) {
            const skeleton = document.createElement('div');
            skeleton.className = 'file-skeleton';
            container.appendChild(skeleton);
        }

        try {
            let url;
            switch (sectionId) {
                case 'shared':
                    url = '/api/storage/getShared';
                    break;
                case 'my-files':
                    url = '/api/storage/files';
                    break;
                case 'trash':
                    url = '/api/storage/trash';
                    break;
                default:
                    container.innerHTML = '<div style="color:red;">Unknown section</div>';
                    return;
            }

            const res = await fetch(url, {
                method: 'GET',
                credentials: 'include'
            });
            if (!res.ok) throw new Error('Failed to load');

            const files = await res.json();
            fileCache[sectionId] = files;
            renderFiles(files);
        } catch (err) {
            container.innerHTML = '<div style="color:red;">Failed to load files</div>';
        }
    }

    async function loadUserData() {
        try {
            const res = await fetch('/api/userdata', { credentials: 'include' });
            if (!res.ok) throw new Error('Unauthorized');
            const data = await res.json();
            document.getElementById("current_folder_id").value = data.rootId;
            document.getElementById('userName').textContent = data.username;
            document.getElementById('userName').classList.remove('skeleton');
            document.getElementById('quotaInfo').textContent = `${formatBytes(data.usedQuota)} / ${formatBytes(data.quota)}`;
            document.getElementById('quotaInfo').classList.remove('skeleton');
        } catch (e) {
            window.location.href = '/auth.html';
        }
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return parseFloat((bytes / Math.pow(1024, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function setupContextMenu() {
        const contextMenu = document.getElementById('contextMenu');

        document.addEventListener('click', (e) => {
            if (!contextMenu.contains(e.target)) {
                contextMenu.style.display = 'none';
                resetFileSelection();
            }
        });

        document.getElementById('filesContainer').addEventListener('contextmenu', (e) => {
            const item = e.target.closest('.file-item');
            if (!item) return;

            e.preventDefault();
            selectedFile = item;

            resetFileSelection();
            item.style.borderColor = '#ff0';

            positionContextMenu(e, contextMenu);
        });

        document.querySelectorAll('.context-menu-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const action = e.currentTarget.getAttribute('data-action');
                handleContextMenuAction(action);
                contextMenu.style.display = 'none';
            });
        });
    }

    function positionContextMenu(e, menu) {
        const menuWidth = menu.offsetWidth;
        const menuHeight = menu.offsetHeight;
        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight;

        let posX = e.clientX;
        let posY = e.clientY;

        if (posX + menuWidth > windowWidth) {
            posX = windowWidth - menuWidth - 5;
        }

        if (posY + menuHeight > windowHeight) {
            posY = windowHeight - menuHeight - 5;
        }

        menu.style.left = `${posX}px`;
        menu.style.top = `${posY}px`;
        menu.style.display = 'block';
    }audioTitle

    function resetFileSelection() {
        document.querySelectorAll('.file-item').forEach(item => {
            item.style.borderColor = 'var(--file-border)';
        });
    }

    async function handleContextMenuAction(action) {
        if (!selectedFile) return;

        const fileName = selectedFile.querySelector('.file-name').textContent;
        const isFolder = selectedFile.getAttribute('data-type') === 'folder';
        const fileId = selectedFile.getAttribute('data-uuid');

        switch(action) {
            case 'open':
                if (isFolder) {
                    folderPath.push({ id: fileId, name: fileName });
                    await loadFolderById(fileId);
                } else {
                    const ext = fileName.split('.').pop().toLowerCase();
                    const audioExt = ['mp3', 'wav', 'ogg'];
                    const previewable = ['txt','png','jpg','jpeg','gif','webp','mp4','webm'];

                    if (audioExt.includes(ext)) {


                        openAudioPlayer(fileId, ext, fileName); // <-- –ø–ª–µ–µ—Ä
                    } else if (previewable.includes(ext)) {
                        openPreviewModal(fileId, fileName, ext); // –æ—Å—Ç–∞–ª—å–Ω–æ–µ –≤ –ø—Ä–µ–≤—å—é
                    } else {
                        showNotification("Preview not supported", `Cannot preview .${ext} files`);
                    }
                }
                break;

            case 'download':
                if (!isFolder) {
                    if (fileId) {
                        showNotification("Download", `Downloading: ${fileName}`);
                        window.location.href = `/api/storage/download/${fileId}`;
                    } else {
                        showNotification("Error", "No UUID found for file.");
                    }
                }
                break;

            case 'rename':
                const newName = prompt("Enter new name:", fileName);
                if (newName && newName !== fileName) {
                    showNotification("Renamed", `Renamed to: ${newName}`);
                }
                break;

            case 'properties':
                openFileProperties(selectedFile);
                break;

            case 'delete':
                if (confirm(`Delete ${isFolder ? 'folder' : 'file'}: ${fileName}?`)) {
                    const response = await fetch(`/api/storage/delete/${fileId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json; charset=UTF-8'
                        },
                        credentials: 'include'
                    })

                    if (!response.ok) throw new Error('Failed to delete');

                    showNotification("Deleted", `${fileName} was deleted`);
                }
                break;
        }
    }

    function openFileProperties(item) {
        const isFolder = item.getAttribute('data-type') === 'folder';
        const fileName = item.querySelector('.file-name').textContent;
        const fileId = item.getAttribute('data-uuid') || 'unknown';
        const fileSize = isFolder ? '-' : '1.5 MB';

        showFileProperties({
            id: fileId,
            name: fileName,
            isFolder: isFolder,
            size: fileSize,
            date: new Date().toLocaleString(),
            owner: 'Current User'
        });
    }

    function showFileProperties(fileData) {
        const panel = document.getElementById('propertiesPanel');
        if (!panel) {
            console.error('Properties panel not found');
            return;
        }

        document.getElementById('propertyFileIcon').textContent = fileData.isFolder ? 'üìÅ' : 'üìÑ';
        document.getElementById('propertyFileName').textContent = fileData.name;
        document.getElementById('propertyFileType').textContent = fileData.isFolder ? 'Folder' : 'File';
        document.getElementById('propertyFileSize').textContent = fileData.size;
        document.getElementById('propertyFileDate').textContent = fileData.date;
        document.getElementById('propertyFileOwner').textContent = fileData.owner;

        panel.classList.add('active');
    }

    document.getElementById('createFolderBtn').addEventListener('click', createNewFolder);
    document.getElementById('uploadFileBtn').addEventListener('click', () => {
        document.getElementById('fileInput').click();
    });

    document.getElementById('fileInput').addEventListener('change', handleFileUpload);

    async function createNewFolder() {
        const folderName = prompt("Enter folder name:");
        if (!folderName) return;

        try {
            const response = await fetch('/api/storage/createFolder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json; charset=UTF-8'
                },
                body: JSON.stringify({
                    folderName: folderName,
                    parentId: document.getElementById("current_folder_id").value
                }),
                credentials: 'include'
            });

            if (!response.ok) throw new Error('Failed to create folder');

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â—É—é –ø–∞–ø–∫—É
            if (currentPath !== 'my-files' && currentPath !== 'shared' && currentPath !== 'trash') {
                delete fileCache[currentPath];
                await loadFolderById(currentPath);
            } else {
                delete fileCache[currentPath];
                loadSectionContent(currentPath);
            }

            showNotification("Folder created", `Folder "${folderName}" was created`);
        } catch (error) {
            console.error('Error creating folder:', error);
            showNotification("Error", error.message, "Now");
        }
    }

    async function handleFileUpload(e) {
        const fileInput = e.target;
        const files = fileInput.files;
        const parentFolderId = document.getElementById("current_folder_id").value;

        if (!files || files.length === 0) {
            showNotification("Error", "No files selected", "Now");
            return;
        }

        for (const file of files) {
            if (file.size === 0) {
                showNotification("Error", `File "${file.name}" is empty`, "Now");
                continue;
            }

            await uploadFileInChunks(file, parentFolderId);
        }

        fileInput.value = '';
    }

    async function uploadFileInChunks(file, parentFolderId) {
        const chunkSize = 2 * 1024 * 1024; // 2 MB
        const totalChunks = Math.ceil(file.size / chunkSize);
        const fileId = crypto.randomUUID();

        const notification = showNotification("Uploading", file.name, "Now");

        let startTime = performance.now();
        let uploadedBytes = 0;

        for (let i = 0; i < totalChunks; i++) {
            const chunk = file.slice(i * chunkSize, (i + 1) * chunkSize);
            const formData = new FormData();
            formData.append('chunk', chunk);
            formData.append('fileName', file.name);
            formData.append('fileId', fileId);
            formData.append('chunkIndex', i);
            formData.append('totalChunks', totalChunks);
            formData.append('parentFolderId', parentFolderId);

            const chunkStart = performance.now();
            const res = await fetch('/api/storage/upload/chunk', {
                method: 'POST',
                body: formData,
                credentials: 'include'
            });
            const chunkEnd = performance.now();

            const result = await res.json();

            uploadedBytes += chunk.size;
            const elapsedSec = (chunkEnd - startTime) / 1000;
            const speed = uploadedBytes / elapsedSec; // bytes/sec

            if (result.status === 'partial') {
                const percent = Math.round((uploadedBytes / file.size) * 100);
                notification.updateMessage(
                    `${file.name}\n${percent}% ‚Äî ${formatBytes(uploadedBytes)} / ${formatBytes(file.size)} @ ${formatBytes(speed)}/s`
                );
                notification.updateProgress(percent);
            } else if (result.status === 'completed') {
                notification.updateTitle("Upload complete");
                notification.updateMessage(`‚úÖ ${file.name} –∑–∞–≥—Ä—É–∂–µ–Ω (${formatBytes(file.size)})`);
                notification.updateProgress(100);
                await loadUserData();
                delete fileCache[currentPath];
                if (currentPath !== 'my-files' && currentPath !== 'shared' && currentPath !== 'trash') {
                    await loadFolderById(currentPath);
                } else {
                    loadSectionContent(currentPath);
                }
            } else if (result.status === 'error') {
                notification.updateTitle("–û—à–∏–±–∫–∞");
                notification.updateMessage(result.message);
                notification.updateProgress(0);
                break;
            }
        }

        // –∑–∞–∫—Ä—ã—Ç–∏–µ –≤—Ä—É—á–Ω—É—é (—á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏)
        notification.autoClose(3000);
    }

    function updateBreadcrumb() {
        const pathBar = document.getElementById('currentPath');
        pathBar.innerHTML = '';

        const root = document.createElement('span');
        root.textContent = 'home';
        root.classList.add('breadcrumb');
        root.style.cursor = 'pointer';
        root.style.fontWeight = folderPath.length === 0 ? 'bold' : 'normal';
        root.addEventListener('click', () => {
            folderPath = [];
            loadSectionContent('my-files');
        });
        pathBar.appendChild(root);

        folderPath.forEach((item, index) => {
            const separator = document.createTextNode(' / ');
            pathBar.appendChild(separator);

            const crumb = document.createElement('span');
            crumb.textContent = item.name;
            crumb.classList.add('breadcrumb');
            crumb.style.cursor = 'pointer';
            crumb.style.fontWeight = index === folderPath.length - 1 ? 'bold' : 'normal';
            crumb.addEventListener('click', () => {
                folderPath = folderPath.slice(0, index + 1);
                loadFolderById(item.id);
            });
            pathBar.appendChild(crumb);
        });
    }

    async function loadFolderById(folderUuid) {
        try {
            const res = await fetch(`/api/storage/folder/${folderUuid}`, {
                method: 'GET',
                credentials: 'include'
            });
            if (!res.ok) throw new Error('Failed to load folder');

            const folderDto = await res.json();

            fileCache[folderUuid] = folderDto.fileDtos;
            renderFiles(folderDto.fileDtos);

            document.getElementById("current_folder_id").value = folderDto.id;
            currentPath = folderUuid;

            updateBreadcrumb();
        } catch (err) {
            console.error(err);
            showNotification("Error", "Could not load folder");
        }
    }

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('active');

        const overlay = document.createElement('div');
        overlay.className = 'sidebar-overlay';
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.right = '0';
        overlay.style.bottom = '0';
        overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
        overlay.style.zIndex = '80';
        overlay.style.display = sidebar.classList.contains('active') ? 'block' : 'none';
        overlay.onclick = toggleSidebar;

        const existingOverlay = document.querySelector('.sidebar-overlay');
        if (existingOverlay) {
            existingOverlay.remove();
        }

        if (sidebar.classList.contains('active')) {
            document.body.appendChild(overlay);
        }
    }



</script>

<script th:src="@{/script/script.js}"></script>
</body>
</html>